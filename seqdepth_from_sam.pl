#!/usr/bin/perl
use strict;
use warnings;
#input .sam from bowtie2
#perl xxx.pl xxx.sam > xxx.out
#HWI-7001446:655:C9080ANXX:8:1101:1963:2046	77	*	0	0	*	*	0	0	TCCTTTGAGAGGTTCGTGCCTTGTTTCCTCCTTTTGTGCTGCGATCTCTGGATTCTGGAAACTTCTCAAGTCCTCGGCTTTACATTCTTGGTGTGGAGCGGTTATACCCCGGGGTTAACTTTTCG	BB<<BBBFFBFFF//FFFFFFFFF/BFF<FF<FF<FB/<<<<B/<F/</FF</<BF/BBFBF/</<F<//B<<FF/B<F//<</<<F<B/F/FFBFFBF</<7B/<FB#################	YT:Z:UP
#HWI-7001446:655:C9080ANXX:8:1101:1963:2046	141	*	0	0	*	*	0	0	AATTTTAAAAAAACCAAATTAGCTTCCATAAAATTGCTAAGTCTTGTTTGTGAAACCTATTAGCCGGTTTTCTTACCGTGTTGACCGAAAGTCATGGCTTTTTACTGGTTTTCTGTAAACCGATG	/<BBBFF<FBFFFFFFF</F/BFFFFFBFFFFFF<BFFFFF<FF/BBF/BBFFBFFFFBF<FBFFFF7///</F/<BF<FFF<B/FB//</<<<//BBBFBF#######################	YT:Z:UP
#HWI-7001446:655:C9080ANXX:8:1101:1952:2085	83	Chr12	24835792	42	125M	=	24835663	-254	ACATCATATACTTGAAACTTCCTGTTCAATTGGACATCTACCAGGATACTATTGAACATGAGTAATATTGTTGTTGCACTACATCCCAACCATGATCTTTGGACAACAAGTTTAAAGAGTTTGCA	####################BFFF<B//</FFFF</B<<<<//F/FFFF<FFFF<</B/</F</<FFF<</FFF<<<//</7<</////B</FFBFFFFF/FBF<<BFFBB/F<<BB//<BBB<B	AS:i:-8	XN:i:0	XM:i:3	XO:i:0	XG:i:0	NM:i:3	MD:Z:19C64A1A38	YS:i:-13	YT:Z:CP
#HWI-7001446:655:C9080ANXX:8:1101:1952:2085	163	Chr12	24835663	42	125M	=	24835792	254	TACATACGATGTATGATTATCTGCAATAACTCTAAGATCTGCAGGCTTCACTTTAATGAGGCACACTCCTACACGAAATTAACAACGAGCTGTTAAATTCAGCATTTTAATGTGGCCCTGCAACT	<<<</<///FF<<<</B/<<F<FF<FF<FF/BBB/<//<FBF</<</<<<BFB/FB/BBFBBFFFF<BFBFFF/<<F################################################	AS:i:-13	XN:i:0	XM:i:5	XO:i:0	XG:i:0	NM:i:5	MD:Z:7T9G55A12T27C10	YS:i:-8	YT:Z:CP
#HWI-7001446:655:C9080ANXX:8:1101:1984:2117	99	Chr4	27357436	42	125M	=	27357667	356	TTTGTCGCACCACGGCAGCAAAATTATCGGATCTGAAATTCTGAATTGGCCAGAATTAGGTGGATATATGTTTGCATGTTTGAATTCTTCTCCCCCTGTGCTGTTTCTGTAGTGAAGTGCTATCT	B</BB/<FBFFFFFFFFBFFF/B///<///7<</<FFFF/F///<F////<F/B</</FF//<FFFF//<//<B/F<<<</BF<//<</F/<F<FFB///<BB######################	AS:i:-5	XN:i:0	XM:i:2	XO:i:0	XG:i:0	NM:i:2	MD:Z:61T52T10	YS:i:-18	YT:Z:CP
#HWI-7001446:655:C9080ANXX:8:1101:1984:2117	147	Chr4	27357667	42	125M	=	27357436	-356	ATATCAAAGTTCACTCTGCATTCTTTCTTGTGCCATTTGCCGTGGAATTATGGCTGGACCTTTTACTACACTGACAACGTTGAGTTTTCGTTGGTACGTATCGAACATAATTTCTGAATTAGTCC	############################FFFBFF/<///</<//</F/<///</B/<<FFFF//BF<//<</</BFFBF/</</<BB/BFFB<<////<</<<//FF/FFFBB/B<</</BBBBB	AS:i:-18	XN:i:0	XM:i:7	XO:i:0	XG:i:0	NM:i:7	MD:Z:1G11A1G22A14A1C38A30	YS:i:-5	YT:Z:CP

open IN, $ARGV[0] or die $!;
my %hash;
while(<IN>){
	chomp;
	next if !/MD:Z:/;
	my($chr,$star,$CIRG) = (split /\t/,$_)[2,3,5];
	next if $CIRG !~ /[MDI]/;
	my $match = 0;
	my $deletion = 0;
	my $instertion = 0;
	while ($CIRG =~ /(\d+)M/g){
		$match += $1;
	}
	while ($CIRG =~ /(\d+)D/g){
		$deletion += $1;
	}
	while ($CIRG =~ /(\d+)I/g){
		$instertion += $1;
	}
	my $length = $match + $deletion - $instertion;

	for(my$star1 = $star;$star1 < $star + $length;$star1++){
		$hash{$chr}{$star1} ++;
	}
}
for my$chr(sort keys %hash){
	for my$pos(sort {$a <=> $b} keys %{$hash{$chr}}){
		print "$chr\t$pos\t$hash{$chr}{$pos}\n";
	}
}
